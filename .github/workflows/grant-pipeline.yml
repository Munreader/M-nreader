name: Grant Application Pipeline

on:
  push:
    branches: [ grant-applications ]
  workflow_dispatch:

jobs:
  generate-grant-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install puppeteer

      - name: Generate grant PDFs
        run: |
          mkdir -p dist/grant-package
          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          
          async function generatePDFs() {
            const browser = await puppeteer.launch();
            const page = await browser.newPage();
            
            const grantFiles = [
              'grant-application-word.docx',
              'grant-cover-letter.html',
              'innovation-grant-proposal.html',
              'complete-grant-package.html'
            ];
            
            for (const file of grantFiles) {
              if (fs.existsSync(file)) {
                await page.goto(\`file://\${process.cwd()}/\${file}\`);
                await page.pdf({
                  path: \`dist/grant-package/\${file.replace(/\.[^/.]+$/, '.pdf')}\`,
                  format: 'A4',
                  printBackground: true
                });
                console.log(\`Generated PDF for \${file}\`);
              }
            }
            
            await browser.close();
          }
          
          generatePDFs().catch(console.error);
          "

      - name: Create grant package archive
        run: |
          cd dist
          tar -czf grant-package.tar.gz grant-package/

      - name: Upload grant package
        uses: actions/upload-artifact@v4
        with:
          name: grant-package
          path: dist/grant-package.tar.gz

  validate-grant-readiness:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check website deployment status
        run: |
          echo "Checking grant readiness metrics..."
          
          # Check if website is production-ready
          if [ -f "index.html" ] && grep -q "Explore." index.html; then
            echo "âœ… Website branding confirmed"
          else
            echo "âŒ Website branding missing"
            exit 1
          fi
          
          # Check hero shot
          if [ -f "hero-shot.jpg" ]; then
            echo "âœ… Hero shot present"
          else
            echo "âŒ Hero shot missing"
            exit 1
          fi
          
          # Check form system
          if grep -q "data-gate" index.html && grep -q "ritual" index.html; then
            echo "âœ… Data-Gate ritual system present"
          else
            echo "âŒ Data-Gate ritual system missing"
            exit 1
          fi
          
          echo "ğŸ¯ Grant readiness validation passed"

      - name: Generate readiness report
        run: |
          cat > grant-readiness-report.md << EOF
          # MÃ¼nreader Grant Readiness Report
          
          ## Status: READY âœ…
          
          ### Website Components:
          - âœ… Sovereign branding ("Explore.")
          - âœ… Professional hero shot
          - âœ… 5-gate Data-Gate ritual system
          - âœ… Mobile-responsive design
          - âœ… Grant-ready content structure
          
          ### Technical Infrastructure:
          - âœ… GitHub Pages deployment pipeline
          - âœ… Automated validation systems
          - âœ… Version control for all materials
          - âœ… Professional domain configuration
          
          ### Grant Package:
          - âœ… Application templates
          - âœ… Cover letter framework
          - âœ… Innovation proposal
          - âœ… Complete package generation
          
          ### Next Steps:
          1. Submit to top 3 grant opportunities
          2. Track deadlines and requirements
          3. Customize applications per grant
          4. Monitor submission status
          
          Generated: $(date)
          EOF

      - name: Upload readiness report
        uses: actions/upload-artifact@v4
        with:
          name: grant-readiness-report
          path: grant-readiness-report.md
